"""
Tescan device implementation.

This module contains the implementation of a Tescan device with
specific parameter and result types.
"""
import time
from typing import Dict, TypedDict
from dp.agent.lab.device.types import SuccessResult, BaseParams, ErrorResult
from dp.agent.lab.device.device import Device, action

# 这些类型定义通常在实际项目中会从 device 模块导入
# 这里为了示例，我们直接在本地定义
class BaseParams(TypedDict):
    """Base parameters type."""
    pass

class SuccessResult(TypedDict):
    """Base success result type."""
    message: str
    data: Dict

class ErrorResult(TypedDict):
    """Base error result type."""
    message: str
    data: Dict

class Device:
    """Base device class."""
    device_name: str = "base_device"

def action(name: str):
    """Action decorator."""
    def decorator(func):
        def wrapper(*args, **kwargs):
            return func(*args, **kwargs)
        return wrapper
    return decorator

# 参数类型定义
class TakePictureParams(BaseParams):
    """Parameters for take_picture action."""
    horizontal_width: str

class GetStagePositionParams(BaseParams):
    """Parameters for get_stage_position action."""
    pass

class MoveStageParams(BaseParams):
    """Parameters for move_stage action."""
    x: float
    y: float
    z: float

# 返回数据类型定义
class StagePosition(TypedDict):
    """Stage position data."""
    x: float
    y: float
    z: float

class PictureData(TypedDict):
    """Picture data."""
    image_id: str

class StagePositionResult(SuccessResult):
    """Result for get_stage_position action."""
    data: StagePosition

class PictureResult(SuccessResult):
    """Result for take_picture action."""
    data: PictureData

class MoveStageResult(SuccessResult):
    """Result for move_stage action."""
    data: Dict[str, float]

class TescanDevice(Device):
    """Tescan device implementation."""
    device_name = "tescan"

    @action("take_picture")
    def take_picture(self, params: TakePictureParams) -> PictureResult:
        """Take a picture with the microscope.
        
        Args:
            params: Parameters for the action
                - horizontal_width: Horizontal width of the image
                
        Returns:
            Result of the action
        """
        time.sleep(1)
        
        hw = params.get("horizontal_width", "default")
        
        return PictureResult(
            message=f"Picture taken with {self.device_name} (width: {hw})",
            data={"image_id": "mock_image_123"}
        )
    
    @action("get_stage_position")
    def get_stage_position(self, params: GetStagePositionParams) -> StagePositionResult:
        """Get the stage position.
        
        Args:
            params: Parameters for the action (none required)
                
        Returns:
            Result of the action with x, y, z coordinates
        """
        time.sleep(0.5)
        
        return StagePositionResult(
            message=f"Stage position retrieved for {self.device_name}",
            data=StagePosition(
                x=10.5,
                y=20.3,
                z=5.1
            )
        )
    
    @action("move_stage")
    def move_stage(self, params: MoveStageParams) -> MoveStageResult:
        """Move the stage to a new position.
        
        Args:
            params: Parameters for the action
                - x: X coordinate
                - y: Y coordinate
                - z: Z coordinate
                
        Returns:
            Result of the action
        """
        time.sleep(2)
        
        if not all(k in params for k in ["x", "y", "z"]):
            # Use a proper MoveStageResult with error status instead of ErrorResult
            return MoveStageResult(
                message=f"Missing required parameters: x, y, z",
                data={}
            )
        
        try:
            new_position = {
                "x": float(params["x"]),
                "y": float(params["y"]),
                "z": float(params["z"])
            }
            
            return MoveStageResult(
                message=f"Stage moved for {self.device_name}",
                data=new_position
            )
        except (KeyError, TypeError, ValueError):
            # Use a proper MoveStageResult with error status instead of ErrorResult
            return MoveStageResult(
                message=f"Invalid parameters: x, y, z must be numeric values",
                data={}
            ) 